flowchart TD
    A[User A Shares Link: /register?r=CODE_A] --> B[User B Registers]
    B -->|Optional referralCode present| C[Create Referral: referrer=A, referred=B, status=pending]
    B --> D[User B Logs In]
    D --> E[User B Buys (POST /purchase)]
    E -->|Check hasPurchased=false| F[Set hasPurchased=true]
    F --> G[Find Referral by referredUser=B]
    G --> H[Update Referral status=converted]
    H --> I[Atomic Credits: $inc A.credits += 2 and B.credits += 2]
    I --> J[Dashboard Updates]

    E -->|hasPurchased=true| K[Reject: Already Purchased]
